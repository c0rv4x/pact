(env-data {"keyset": { "keys": ["bob"], "pred": "keys-any" }})
(env-keys ["bob"])
(begin-tx)
(define-namespace 'free (read-keyset 'keyset) (read-keyset 'keyset))
(commit-tx)
(begin-tx)
(env-exec-config ['DisablePact43])
(namespace 'free)
(module modA G
  (defcap G () true)
  (defun func (x) (+ 1 x))
  (defconst test:string "hi")
  )
(module modB G
  (defcap G () true)
  (defun chain () (modA.func 10))
  (defconst test:string "hello")
  (defun get-test() test)
  )

(expect "ns-scoped module call works fully qualified" (free.modB.chain) 11)

(namespace 'free)

(expect "ns-scoped module call works within namespace scope" (modB.chain) 11)

(expect "selects incorrect test" (modB.get-test) "hi")
(commit-tx)

(begin-tx)
(env-exec-config [])
(namespace 'free)
(module modA G
  (defcap G () true)
  (defun func (x) (+ 1 x))
  (defconst test:string "hi")
  )
(module modB G
  (defcap G () true)
  (defun chain () (modA.func 10))
  (defconst test:string "hello")
  (defun get-test() test)
  )

(expect "ns-scoped module call works fully qualified" (free.modB.chain) 11)

(namespace 'free)

(expect "ns-scoped module call works within namespace scope" (modB.chain) 11)

(expect "selects correct test" (modB.get-test) "hello")
(commit-tx)

; works across different txs
(begin-tx)
(namespace 'free)
(module modA G
  (defcap G () true)
  (defun func (x) (+ 1 x))
  (defconst test:string "hi")
  )
(commit-tx)
(begin-tx)
(namespace 'free)
(module modB G
  (defcap G () true)
  (defun chain () (modA.func 10))
  (defconst test:string "hello")
  (defun get-test() test)
  )

(expect "ns-scoped module call works fully qualified" (free.modB.chain) 11)

(namespace 'free)

(expect "ns-scoped module call works within namespace scope" (modB.chain) 11)

(expect "selects correct test" (modB.get-test) "hello")
(commit-tx)

;;
;; Module redeploy name resolution
;;

(begin-tx)
(namespace 'free)
(module test-mod-redeploy-ref g
  (defcap g () true)

  (defcap test ()
    (enforce false "boom"))

  (defun f ()
    (with-capability (test)
      1))
  )
(expect-failure "Execution fails due to the falsy defcap" (f))
(expect-failure "Execution fails due to the falsy defcap" (test-mod-redeploy-ref.f))
(expect-failure "Execution fails due to the falsy defcap" (free.test-mod-redeploy-ref.f))


(commit-tx)

(begin-tx)
(namespace 'free)
(module test-mod-redeploy-ref g
  (defcap g () true)
  (defcap test ()
    true)
  (defun f ()
    (with-capability (free.test-mod-redeploy-ref.test)
      1))

  (defun f1 ()
    (with-capability (test-mod-redeploy-ref.test)
      1))
  
  )
(expect "Name resolution should find new reference" 1 (f))
(expect "Name resolution should find new reference" 1 (test-mod-redeploy-ref.f))
(expect "Name resolution should find new reference" 1 (free.test-mod-redeploy-ref.f))

(expect "Name resolution should find new reference" 1 (f1))
(expect "Name resolution should find new reference" 1 (test-mod-redeploy-ref.f1))
(expect "Name resolution should find new reference" 1 (free.test-mod-redeploy-ref.f1))
(commit-tx)

; pact 4.7 behaviour

(begin-tx)
(namespace 'free)
(module test-mod-redeploy-ref g
  (defcap g () true)

  (defcap test ()
    (enforce false "boom"))

  (defun f ()
    (with-capability (test)
      1))
  )
(commit-tx)

(begin-tx)
(env-exec-config ["DisablePact48"])
(namespace 'free)
;; (module test-mod-redeploy-ref g
;;   (defcap g () true)
;;   (defcap test ()
;;     true)
;;   (defun f ()
;;     (with-capability (free.test-mod-redeploy-ref.test)
;;       1))
;;   )

;(expect-failure "Name resolution should find old reference of prev. deployed module" (f))
(expect-failure "Name resolution should find old reference of prev. deployed module" (test-mod-redeploy-ref.f))
(expect-failure "Name resolution should find old reference of prev. deployed module" (free.test-mod-redeploy-ref.f))
(commit-tx)
